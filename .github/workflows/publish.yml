name: Publish to VS Code Marketplace

on:
    push:
        tags:
            - "v*" # Triggers on version tags like v1.2.2, v1.3.0, etc.
    workflow_dispatch: # Allows manual triggering

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm install

            - name: Install vsce
              run: npm install -g @vscode/vsce

            - name: Verify package.json version matches tag
              if: startsWith(github.ref, 'refs/tags/v')
              run: |
                  TAG_VERSION=${GITHUB_REF#refs/tags/v}
                  PACKAGE_VERSION=$(node -p "require('./package.json').version")
                  if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
                    echo "Error: Tag version ($TAG_VERSION) doesn't match package.json version ($PACKAGE_VERSION)"
                    exit 1
                  fi
                  echo "Version verified: $PACKAGE_VERSION"

            - name: Package extension
              run: vsce package

            - name: Publish to VS Code Marketplace
              env:
                  VSCE_PAT: ${{ secrets.VSCE_PAT }}
              run: vsce publish -p $VSCE_PAT

            - name: Upload VSIX as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: vsix-package
                  path: "*.vsix"
